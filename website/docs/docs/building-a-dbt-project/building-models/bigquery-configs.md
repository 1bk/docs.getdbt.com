---
title: "BigQuery specific configurations"
id: "bigquery-configs"
---

## Using table partitioning and clustering

### Partition clause

BigQuery supports the use of a [partition by](https://cloud.google.com/bigquery/docs/data-definition-language#specifying_table_partitioning_options) clause to easily partition a table by a column or expression. This option can help decrease latency and cost when querying large tables. Note that the expression provided as the `partition_by` field _must_ be of type `Date`, and that partition pruning [only works](https://cloud.google.com/bigquery/docs/querying-partitioned-tables#pruning_limiting_partitions) when comparing using scalar/literal values (so selecting partitions using a subquery won't improve performance).

<File name='bigquery_table.sql'>

```sql
{{ config(materialized='table', partition_by='DATE(created_at)') }}

select
  user_id,
  event_name,
  created_at
  
from {{ ref('events') }}
```

</File>

Because BigQuery only prunes partitions when filters are provided literally, it may be useful to use a [statement block](statement-blocks) to generate filter clauses:

<File name='partition_filter.sql'>

```sql

{% call statement('get_date', fetch_result=True) %}

  SELECT
    min(created_at) as min_date
    
  FROM {{ ref('bigquery_table') }}

{% endcall %}

{% set min_date = load_result('get_date').table.columns['min_date'].values()[0] %}

select
  user_id,
  event_name,
  created_at

from {{ ref('bigquery_table') }}
where created_at >= DATE('{{ min_date }}')
```

</File>


### Clustering Clause

BigQuery tables can be [clustered](https://cloud.google.com/bigquery/docs/clustered-tables) to colocate related data. At present, BigQuery is only able to cluster partitioned tables, so be sure to use the `cluster_by` config in conjunction with the `partition_by` config.

Clustering on a single column:

<File name='bigquery_table.sql'>

```sql
{{
  config(
    materialized = "table",
    partition_by = "date(created_at)",
    cluster_by = "order_id",
  )
}}

select * from ...
```

</File>

Clustering on a multiple columns:

<File name='bigquery_table.sql'>

```sql
{{
  config(
    materialized = "table",
    partition_by = "date(created_at)",
    cluster_by = ["customer_id", "order_id"],
  )
}}

select * from ...
```

</File>

## Persisting model descriptions

<Callout type="info" title="New in dbt v0.14.0">

This functionality is new in dbt v0.14.0. For upgrading instructions, check out [the docs](installation)

</Callout>

The `persist_docs` config can be used to persist the dbt `description` supplied for a model to the resulting BigQuery table or view. The `persist_docs` config is currently only supported on BigQuery for views and tables.

The `persist_docs` config can be specified in the `dbt_project.yml` file, or in a specific model.

<File name='dbt_project.yml'>

```yaml

models:
  # enable docs persistence for all models
  persist_docs:
    relation: true
```

</File>

or:

<File name='models/my_model.sql'>

```sql
{{
  config(persist_docs={"relation": true})
}}

select ...
```

</File>

When the `persist_docs` option is configured appropriately, you'll be able to see your model descriptions in the BigQuery UI:

<Lightbox src="/img/docs/building-a-dbt-project/building-models/73ff737-Screen_Shot_2019-06-24_at_12.29.22_PM.png" title="This description is generated by dbt"/>

## Managing KMS Encryption 

[Customer managed encryption keys](https://cloud.google.com/bigquery/docs/customer-managed-encryption) can be configured for BigQuery tables using the `kms_key_name` model configuration. 

### Using KMS Encryption

To specify the KMS key name for a model (or a group of models), use the `kms_key_name` model configuration. The following example sets the `kms_key_name` for all of the models in the `encrypted/` directory of your dbt project.

<File name='dbt_project.yml'>

```yaml

name: my_project
version: 1.0.0

...

models:
  my_project:
    encrypted:
      kms_key_name: 'projects/PROJECT_ID/locations/global/keyRings/test/cryptoKeys/quickstart'
```

</File>

## Labels and Tags

### Specifying labels

dbt supports the specification of BigQuery labels for the tables and views that it creates. These labels can be specified using the `labels` model config.

The `labels` config can be provided in a model config, or in the `dbt_project.yml` file, as shown below.

**Configuring labels in a model file** 

<File name='model.sql'>

```sql
{{
  config(
    materialized = "table",
    labels = {'contains_pii': 'yes', 'contains_pie': 'no'}
  )
}}

select * from {{ ref('another_model') }}
```

</File>

**Configuring labels in dbt_project.yml** 

<File name='dbt_project.yml'>

```yaml

models:
  my_project:
    snowplow:
      labels:
        domain: clickstream
    finance:
      labels:
        domain: finance
```

</File>



<Lightbox src="/img/docs/building-a-dbt-project/building-models/73eaa8a-Screen_Shot_2020-01-20_at_12.12.54_PM.png" title="Viewing labels in the BigQuery console"/>

### Specifying tags
BigQuery table and view *tags* can be created by supplying an empty string for the label value.

<File name='model.sql'>

```sql
{{
  config(
    materialized = "table",
    labels = {'contains_pii': ''}
  )
}}

select * from {{ ref('another_model') }}
```

</File>
